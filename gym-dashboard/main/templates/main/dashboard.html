{% extends "main/base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start mb-3">
  <h2>Hi, {{ user.username }}</h2>
  <div>
    <button id="btn-generate" class="btn btn-primary me-2" {% if not profile.is_payment_approved %}disabled title="Payment required"{% endif %}>
      <span id="gen-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
      <span id="gen-text">Generate AI Plan</span>
    </button>
    <a class="btn btn-outline-secondary" href="{% url 'edit_profile' %}">Edit Profile</a>
  </div>
</div>

<div class="row">
  <!-- Left column: profile & actions -->
  <div class="col-lg-4 mb-3">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="card-title">Profile</h5>
        <p class="mb-1"><strong>Goal:</strong> {{ profile.goal|default:"—" }}</p>
        <p class="mb-1"><strong>Weight:</strong> {{ profile.weight_kg|default:"—" }} kg</p>
        <p class="mb-1"><strong>Height:</strong> {{ profile.height_cm|default:"—" }} cm</p>
        <p class="mb-1"><strong>Age:</strong> {{ profile.age|default:"—" }}</p>
        <p class="mb-1"><strong>Gender:</strong> {{ profile.gender|default:"—" }}</p>

        <p class="mt-2">
  <strong>Payment:</strong>
  {% if profile.is_payment_approved %}
    <span class="badge bg-success">Approved</span>
  {% elif payment_pending %}
    <span class="badge bg-warning text-dark">Pending</span>
  {% else %}
    <span class="badge bg-secondary">Not paid</span>
  {% endif %}
</p>


        <div class="mt-3 d-grid gap-2">
          <a class="btn btn-outline-success" href="{% url 'add_progress' %}">Add Progress</a>
          <a class="btn btn-outline-primary" href="{% url 'make_payment' %}">Make Payment</a>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <h6>Latest Workout</h6>
        {% if workouts %}
          <div><strong>{{ workouts.0.title }}</strong></div>
          <div class="text-muted small">{{ workouts.0.created_at|date:"Y-m-d H:i" }}</div>
        {% else %}
          <div class="text-muted small">No workout plans yet.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Right column: chart and plans -->
  <div class="col-lg-8">
    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <h5 class="card-title mb-0">Progress</h5>
          <small class="text-muted">Weight over time</small>
        </div>
        <div style="height:220px; margin-top:12px;">
          <canvas id="progressChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">AI Plans</h5>
          <small class="text-muted">Latest first</small>
        </div>

        {% if workouts %}
          <div class="accordion" id="plansAccordion">
            {% for w in workouts %}
              <div class="accordion-item mb-2" id="plan-card-{{ w.id }}">
                <h2 class="accordion-header" id="heading-{{ w.id }}">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ w.id }}" aria-expanded="false" aria-controls="collapse-{{ w.id }}">
                    <div class="me-3">
                      <strong>{{ w.title }}</strong><br>
                      <small class="text-muted">{{ w.created_at|date:"Y-m-d H:i" }}</small>
                    </div>
                  </button>
                </h2>
                <div id="collapse-{{ w.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ w.id }}" data-bs-parent="#plansAccordion">
                  <div class="accordion-body">
                    <pre style="white-space:pre-wrap;">{{ w.content }}</pre>
                    <div class="d-flex justify-content-end gap-2 mt-2">
                      <button class="btn btn-sm btn-outline-secondary btn-copy" data-content="{{ w.content|escapejs }}">Copy</button>
                      <button class="btn btn-sm btn-danger btn-delete" data-id="{{ w.id }}">Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted">No AI plans yet. Generate one to see day-by-day plans here.</p>
        {% endif %}

      </div>
    </div>
  </div>
</div>

<!-- Confirmation modal (re-used for delete if needed) -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <p id="confirmText">Are you sure?</p>
        <div class="d-flex justify-content-end gap-2 mt-3">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="confirmOk" class="btn btn-danger btn-sm">Delete</button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ---------- Chart ---------- */
fetch("{% url 'progress_data' %}")
  .then(r => r.json())
  .then(data => {
    const labels = data.map(d => d.date);
    const weights = data.map(d => d.weight_kg);
    const ctx = document.getElementById('progressChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'Weight (kg)', data: weights, tension: 0.3 }]},
      options: { responsive:true, maintainAspectRatio:false }
    });
  }).catch(() => { /* ignore */ });

/* ---------- Helper: show toast message ---------- */
function showToast(message, type='info') {
  // create toast container if missing
  let container = document.getElementById('toast-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toast-container';
    container.style.position = 'fixed';
    container.style.right = '20px';
    container.style.top = '20px';
    container.style.zIndex = '11000';
    document.body.appendChild(container);
  }

  const colors = {info:'bg-primary text-white', success:'bg-success text-white', error:'bg-danger text-white', warning:'bg-warning text-dark'};
  const toast = document.createElement('div');
  toast.className = 'toast ' + (colors[type] || colors.info);
  toast.style.padding = '10px 14px';
  toast.style.marginTop = '8px';
  toast.style.borderRadius = '8px';
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(()=> { toast.style.opacity = '0'; setTimeout(()=> toast.remove(), 400); }, 3500);
}

/* ---------- Generate Plan (AJAX) ---------- */
const btnGenerate = document.getElementById('btn-generate');
if (btnGenerate) {
  btnGenerate.addEventListener('click', async function() {
    const spinner = document.getElementById('gen-spinner');
    const genText = document.getElementById('gen-text');
    spinner.classList.remove('d-none');
    btnGenerate.disabled = true;
    genText.textContent = 'Generating...';

    try {
      const resp = await fetch("{% url 'generate_plan_ajax' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Accept':'application/json' },
      });
      const data = await resp.json();
      if (resp.ok && data.ok) {
        showToast(data.message || 'Plan generated', 'success');
        // reload only the plans area (simple approach: reload page body via location.reload)
        setTimeout(()=> location.reload(), 800);
      } else {
        showToast(data.message || 'Failed to generate', 'error');
      }
    } catch (e) {
      showToast('Network error while generating plan', 'error');
    } finally {
      spinner.classList.add('d-none');
      btnGenerate.disabled = false;
      genText.textContent = 'Generate AI Plan';
    }
  });
}

/* ---------- Delete Plan (AJAX) ---------- */
let planToDelete = null;
document.querySelectorAll('.btn-delete').forEach(btn => {
  btn.addEventListener('click', function(e) {
    planToDelete = this.getAttribute('data-id');
    // show confirm modal
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    document.getElementById('confirmText').textContent = 'Delete this plan? This action cannot be undone.';
    document.getElementById('confirmOk').textContent = 'Delete';
    confirmModal.show();

    document.getElementById('confirmOk').onclick = async function() {
      confirmModal.hide();
      try {
        const resp = await fetch(`{% url 'delete_plan_ajax' 0 %}`.replace('/0/','/' + planToDelete + '/'), {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Accept':'application/json' },
        });
        const data = await resp.json();
        if (resp.ok && data.ok) {
          showToast('Plan deleted', 'success');
          // remove card from DOM
          const el = document.getElementById('plan-card-' + planToDelete);
          if (el) el.remove();
        } else {
          showToast(data.message || 'Delete failed', 'error');
        }
      } catch (e) {
        showToast('Network error deleting plan', 'error');
      }
    };
  });
});

/* ---------- Copy to clipboard ---------- */
document.querySelectorAll('.btn-copy').forEach(btn => {
  btn.addEventListener('click', function() {
    const content = this.getAttribute('data-content');
    navigator.clipboard.writeText(content).then(()=> showToast('Copied to clipboard','success')).catch(()=> showToast('Copy failed','error'));
  });
});

/* ---------- small helper to read CSRF cookie ---------- */
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}
</script>
{% endblock %}
